using System;
using Savidiy.Utils;
using UnityEngine;

namespace MainModule
{
    public class PlayerInvulnerability : IDisposable
    {
        private readonly TickInvoker _tickInvoker;
        private SpriteRenderer[] _spriteRenderers;
        private readonly GameStaticData _gameStaticData;

        private float _invulnerableTimer;
        private float _blinkTimer;

        public bool IsInvulnerable => _invulnerableTimer > 0;

        public PlayerInvulnerability(TickInvoker tickInvoker, GameStaticData gameStaticData)
        {
            _tickInvoker = tickInvoker;
            _gameStaticData = gameStaticData;
            _tickInvoker.Subscribe(UpdateType.Update, OnUpdated);
        }

        public void SetSpriteRenderers(SpriteRenderer[] spriteRenderers)
        {
            _spriteRenderers = spriteRenderers;
        }

        public void StartInvulnerableTimer()
        {
            _invulnerableTimer = _gameStaticData.HitInvulDuration;
            _blinkTimer = _gameStaticData.BlinkPeriod;
        }

        private void OnUpdated()
        {
            float deltaTime = _tickInvoker.DeltaTime;

            if (_invulnerableTimer <= 0)
                return;

            _invulnerableTimer -= deltaTime;
            UpdateBlink(deltaTime);
        }

        private void UpdateBlink(float deltaTime)
        {
            Color color = Color.white;
            if (_invulnerableTimer > 0)
            {
                _blinkTimer -= deltaTime;
                if (_blinkTimer < 0)
                    _blinkTimer = _gameStaticData.BlinkPeriod;

                if (_blinkTimer > _gameStaticData.BlinkPeriod / 2)
                    color = Color.clear;
            }

            foreach (SpriteRenderer spriteRenderer in _spriteRenderers)
                spriteRenderer.color = color;
        }

        public void Dispose()
        {
            _tickInvoker.Unsubscribe(UpdateType.Update, OnUpdated);
        }
    }
}